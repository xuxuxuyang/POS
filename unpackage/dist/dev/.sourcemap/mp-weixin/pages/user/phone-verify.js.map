{"version":3,"file":"phone-verify.js","sources":["pages/user/phone-verify.vue","D:/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvdXNlci9waG9uZS12ZXJpZnkudnVl"],"sourcesContent":["<template>\r\n  <view class=\"verify-container\">\r\n    <view class=\"verify-header\">\r\n      <text class=\"header-title\">手机号验证</text>\r\n      <text class=\"header-desc\"\r\n        >验证手机号可以提高账号安全性，便于接收服务通知</text\r\n      >\r\n    </view>\r\n\r\n    <view class=\"form-container\">\r\n      <view class=\"form-group\">\r\n        <text class=\"form-label\">手机号</text>\r\n        <input\r\n          type=\"number\"\r\n          class=\"form-input\"\r\n          placeholder=\"请输入手机号码\"\r\n          maxlength=\"11\"\r\n          v-model=\"phone\"\r\n        />\r\n      </view>\r\n\r\n      <view class=\"form-divider\"></view>\r\n\r\n      <view class=\"form-group\">\r\n        <text class=\"form-label\">验证码</text>\r\n        <input\r\n          type=\"number\"\r\n          class=\"form-input\"\r\n          placeholder=\"请输入验证码\"\r\n          maxlength=\"6\"\r\n          v-model=\"code\"\r\n        />\r\n        <view\r\n          class=\"code-btn\"\r\n          :class=\"{ disabled: countdown > 0 }\"\r\n          @click=\"getVerifyCode\"\r\n        >\r\n          {{ countdown > 0 ? `${countdown}秒` : \"获取验证码\" }}\r\n        </view>\r\n      </view>\r\n    </view>\r\n\r\n    <view class=\"submit-btn\" @click=\"submitVerify\"> 验证并绑定 </view>\r\n\r\n    <view class=\"tips-card\">\r\n      <view class=\"tips-header\">\r\n        <image\r\n          src=\"https://cdn-icons-png.flaticon.com/128/1041/1041728.png\"\r\n          class=\"tips-icon\"\r\n        ></image>\r\n        <text class=\"tips-title\">温馨提示</text>\r\n      </view>\r\n      <view class=\"tips-content\">\r\n        <view class=\"tip-item\">\r\n          <text class=\"tip-dot\">•</text>\r\n          <text class=\"tip-text\"\r\n            >为了您的账号安全，一个手机号仅能绑定一个账号</text\r\n          >\r\n        </view>\r\n        <view class=\"tip-item\">\r\n          <text class=\"tip-dot\">•</text>\r\n          <text class=\"tip-text\">手机号将用于登录验证、密码找回等安全服务</text>\r\n        </view>\r\n        <view class=\"tip-item\">\r\n          <text class=\"tip-dot\">•</text>\r\n          <text class=\"tip-text\">如手机号已变更，请联系客服处理</text>\r\n        </view>\r\n      </view>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  data() {\r\n    return {\r\n      phone: \"\",\r\n      code: \"\",\r\n      countdown: 0,\r\n      timer: null,\r\n      userId: \"\",\r\n    };\r\n  },\r\n  onLoad(options) {\r\n    // 检查登录状态\r\n    this.checkLoginStatus();\r\n\r\n    // 从URL参数中获取用户ID\r\n    if (options && options.userId) {\r\n      this.userId = options.userId;\r\n    }\r\n  },\r\n  onShow() {\r\n    this.loadUserPhone();\r\n  },\r\n  onUnload() {\r\n    // 清除定时器\r\n    if (this.timer) {\r\n      clearInterval(this.timer);\r\n      this.timer = null;\r\n    }\r\n  },\r\n  methods: {\r\n    // 检查登录状态\r\n    checkLoginStatus() {\r\n      const userInfo = uni.getStorageSync(\"userInfo\");\r\n      if (!userInfo) {\r\n        uni.showToast({\r\n          title: \"请先登录\",\r\n          icon: \"none\",\r\n          success: () => {\r\n            setTimeout(() => {\r\n              uni.navigateBack();\r\n            }, 1500);\r\n          },\r\n        });\r\n        return;\r\n      }\r\n\r\n      try {\r\n        const userInfoObj = JSON.parse(userInfo);\r\n        this.userId = userInfoObj._id;\r\n      } catch (e) {\r\n        console.error(\"解析用户信息失败\", e);\r\n      }\r\n    },\r\n\r\n    // 加载用户手机号\r\n    loadUserPhone() {\r\n      if (!this.userId) return;\r\n\r\n      const db = wx.cloud.database();\r\n      db.collection(\"userinfo\")\r\n        .doc(this.userId)\r\n        .get()\r\n        .then((res) => {\r\n          if (res.data && res.data.phone) {\r\n            this.phone = res.data.phone;\r\n          }\r\n        })\r\n        .catch((err) => {\r\n          console.error(\"获取用户手机号失败\", err);\r\n        });\r\n    },\r\n\r\n    // 获取验证码\r\n    getVerifyCode() {\r\n      if (this.countdown > 0) return;\r\n\r\n      // 验证手机号格式\r\n      if (!/^1\\d{10}$/.test(this.phone)) {\r\n        uni.showToast({\r\n          title: \"请输入正确的手机号\",\r\n          icon: \"none\",\r\n        });\r\n        return;\r\n      }\r\n\r\n      // 模拟发送验证码\r\n      uni.showLoading({\r\n        title: \"发送中...\",\r\n      });\r\n\r\n      // 这里应该调用后端API发送验证码\r\n      // 这里使用模拟数据\r\n      setTimeout(() => {\r\n        uni.hideLoading();\r\n        uni.showToast({\r\n          title: \"验证码已发送\",\r\n          icon: \"success\",\r\n        });\r\n\r\n        // 开始倒计时\r\n        this.countdown = 60;\r\n        this.timer = setInterval(() => {\r\n          this.countdown--;\r\n          if (this.countdown <= 0) {\r\n            clearInterval(this.timer);\r\n            this.timer = null;\r\n          }\r\n        }, 1000);\r\n      }, 1500);\r\n    },\r\n\r\n    // 提交验证\r\n    submitVerify() {\r\n      if (!this.phone) {\r\n        uni.showToast({\r\n          title: \"请输入手机号\",\r\n          icon: \"none\",\r\n        });\r\n        return;\r\n      }\r\n\r\n      if (!this.code) {\r\n        uni.showToast({\r\n          title: \"请输入验证码\",\r\n          icon: \"none\",\r\n        });\r\n        return;\r\n      }\r\n\r\n      // 验证手机号格式\r\n      if (!/^1\\d{10}$/.test(this.phone)) {\r\n        uni.showToast({\r\n          title: \"请输入正确的手机号\",\r\n          icon: \"none\",\r\n        });\r\n        return;\r\n      }\r\n\r\n      // 验证验证码格式\r\n      if (!/^\\d{6}$/.test(this.code)) {\r\n        uni.showToast({\r\n          title: \"请输入6位数字验证码\",\r\n          icon: \"none\",\r\n        });\r\n        return;\r\n      }\r\n\r\n      // 提交验证\r\n      uni.showLoading({\r\n        title: \"验证中...\",\r\n      });\r\n\r\n      // 这里应该调用后端API验证验证码\r\n      // 这里使用模拟数据，真实情况应连接服务器验证\r\n      setTimeout(() => {\r\n        // 更新数据库中的手机号\r\n        const db = wx.cloud.database();\r\n        db.collection(\"userinfo\")\r\n          .doc(this.userId)\r\n          .update({\r\n            data: {\r\n              phone: this.phone,\r\n              isPhoneVerified: true,\r\n              updateTime: new Date(),\r\n            },\r\n          })\r\n          .then(() => {\r\n            // 更新本地缓存\r\n            const userInfoStr = uni.getStorageSync(\"userInfo\");\r\n            if (userInfoStr) {\r\n              try {\r\n                const userInfo = JSON.parse(userInfoStr);\r\n                userInfo.phone = this.phone;\r\n                userInfo.isPhoneVerified = true;\r\n                uni.setStorageSync(\"userInfo\", JSON.stringify(userInfo));\r\n              } catch (e) {\r\n                console.error(\"更新本地用户信息失败\", e);\r\n              }\r\n            }\r\n\r\n            uni.hideLoading();\r\n            uni.showToast({\r\n              title: \"验证成功\",\r\n              icon: \"success\",\r\n            });\r\n\r\n            // 成功后返回上一页\r\n            setTimeout(() => {\r\n              uni.navigateBack();\r\n            }, 1500);\r\n          })\r\n          .catch((err) => {\r\n            console.error(\"更新用户手机号失败\", err);\r\n            uni.hideLoading();\r\n            uni.showToast({\r\n              title: \"验证失败，请重试\",\r\n              icon: \"none\",\r\n            });\r\n          });\r\n      }, 1500);\r\n    },\r\n  },\r\n};\r\n</script>\r\n\r\n<style>\r\n.verify-container {\r\n  min-height: 100vh;\r\n  background-color: #f7f7f7;\r\n  padding-bottom: 30rpx;\r\n}\r\n\r\n.verify-header {\r\n  padding: 40rpx 30rpx;\r\n  background-color: #fff;\r\n}\r\n\r\n.header-title {\r\n  font-size: 36rpx;\r\n  font-weight: bold;\r\n  color: #333;\r\n  margin-bottom: 10rpx;\r\n}\r\n\r\n.header-desc {\r\n  font-size: 26rpx;\r\n  color: #999;\r\n}\r\n\r\n.form-container {\r\n  margin-top: 20rpx;\r\n  background-color: #fff;\r\n}\r\n\r\n.form-group {\r\n  display: flex;\r\n  align-items: center;\r\n  padding: 30rpx;\r\n}\r\n\r\n.form-label {\r\n  width: 160rpx;\r\n  font-size: 30rpx;\r\n  color: #333;\r\n}\r\n\r\n.form-input {\r\n  flex: 1;\r\n  font-size: 30rpx;\r\n  height: 60rpx;\r\n}\r\n\r\n.form-divider {\r\n  height: 1rpx;\r\n  background-color: #eee;\r\n  margin-left: 30rpx;\r\n}\r\n\r\n.code-btn {\r\n  background-color: #1296db;\r\n  color: #fff;\r\n  font-size: 26rpx;\r\n  padding: 10rpx 20rpx;\r\n  border-radius: 6rpx;\r\n  margin-left: 20rpx;\r\n}\r\n\r\n.code-btn.disabled {\r\n  background-color: #cccccc;\r\n}\r\n\r\n.submit-btn {\r\n  margin: 60rpx 30rpx;\r\n  height: 90rpx;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  background-color: #1296db;\r\n  color: #fff;\r\n  font-size: 32rpx;\r\n  border-radius: 45rpx;\r\n  box-shadow: 0 4rpx 20rpx rgba(18, 150, 219, 0.3);\r\n}\r\n\r\n.tips-card {\r\n  margin: 30rpx;\r\n  background-color: #fff;\r\n  border-radius: 12rpx;\r\n  padding: 30rpx;\r\n  box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);\r\n}\r\n\r\n.tips-header {\r\n  display: flex;\r\n  align-items: center;\r\n  margin-bottom: 20rpx;\r\n}\r\n\r\n.tips-icon {\r\n  width: 36rpx;\r\n  height: 36rpx;\r\n  margin-right: 10rpx;\r\n}\r\n\r\n.tips-title {\r\n  font-size: 30rpx;\r\n  font-weight: bold;\r\n  color: #333;\r\n}\r\n\r\n.tips-content {\r\n  padding-left: 10rpx;\r\n}\r\n\r\n.tip-item {\r\n  display: flex;\r\n  margin-bottom: 10rpx;\r\n}\r\n\r\n.tip-dot {\r\n  margin-right: 10rpx;\r\n  color: #1296db;\r\n  font-weight: bold;\r\n}\r\n\r\n.tip-text {\r\n  font-size: 26rpx;\r\n  color: #666;\r\n  line-height: 1.6;\r\n}\r\n</style>\r\n","import MiniProgramPage from 'C:/Users/Administrator/Desktop/wx-pos/pages/user/phone-verify.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","wx"],"mappings":"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"}