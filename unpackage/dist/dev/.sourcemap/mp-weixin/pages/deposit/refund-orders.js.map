{"version":3,"file":"refund-orders.js","sources":["pages/deposit/refund-orders.vue","D:/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvZGVwb3NpdC9yZWZ1bmQtb3JkZXJzLnZ1ZQ"],"sourcesContent":["<template>\r\n  <view class=\"refund-orders-container\">\r\n    \r\n    \r\n    <!-- 记录列表 -->\r\n    <view class=\"refund-list\">\r\n      <view v-if=\"loading\" class=\"loading\">\r\n        <text>加载中...</text>\r\n      </view>\r\n      \r\n      <view v-else-if=\"refundOrders.length === 0\" class=\"empty-state\">\r\n        <image src=\"/static/empty.png\" mode=\"aspectFit\" class=\"empty-image\"></image>\r\n        <text class=\"empty-text\">暂无退款记录</text>\r\n      </view>\r\n      \r\n      <view v-else>\r\n        <!-- 记录列表项 -->\r\n        <view \r\n          v-for=\"(item, index) in refundOrders\" \r\n          :key=\"index\" \r\n          class=\"refund-item\"\r\n          @click=\"goToDetail(item._id || item.orderId || item.orderInfo?.id, item)\"\r\n        >\r\n          <view class=\"refund-info\">\r\n            <view class=\"refund-product\">{{ item.productName }}</view>\r\n            <view class=\"refund-amount\">¥{{ item.amount }}</view>\r\n          </view>\r\n          \r\n          <view class=\"refund-meta\">\r\n            <view class=\"refund-order\">\r\n              <text class=\"label\">订单号：</text>\r\n              <text class=\"value\">{{ item.orderId }}</text>\r\n            </view>\r\n            <view class=\"refund-time\">\r\n              <text class=\"label\">申请时间：</text>\r\n              <text class=\"value\">{{ formatDate(item.applyTime) }}</text>\r\n            </view>\r\n          </view>\r\n          \r\n          <view class=\"refund-status\">\r\n            <view :class=\"['status-tag', getStatusClass(item.status)]\">{{ getStatusText(item.status) }}</view>\r\n            <text class=\"arrow\">></text>\r\n          </view>\r\n        </view>\r\n      </view>\r\n    </view>\r\n    \r\n    \r\n  </view>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  data() {\r\n    return {\r\n      loading: true,\r\n      refundOrders: [],\r\n      userId: \"\", // 用户ID\r\n    };\r\n  },\r\n  onLoad() {\r\n    // 初始化云环境\r\n    wx.cloud.init({\r\n      env: \"cloud1-9grox8bwd6dbce0c\",\r\n      traceUser: true,\r\n    });\r\n    \r\n    // 获取用户ID - 这里不再使用，小程序端默认只能查询到自己创建的记录\r\n    this.userId = uni.getStorageSync(\"userId\") || \"\";\r\n    \r\n    // 加载退款记录\r\n    this.loadRefundOrders();\r\n  },\r\n  \r\n  onShow() {\r\n    // 每次显示页面时都刷新数据，确保能看到最新申请的记录\r\n    this.loadRefundOrders();\r\n    \r\n    // 清除进入详情页时使用的临时缓存\r\n    uni.removeStorageSync(\"current_refund_detail\");\r\n  },\r\n  onPullDownRefresh() {\r\n    this.loadRefundOrders(() => {\r\n      uni.stopPullDownRefresh();\r\n    });\r\n  },\r\n  methods: {\r\n    // 加载退款记录\r\n    loadRefundOrders(callback) {\r\n      this.loading = true;\r\n      \r\n      const db = wx.cloud.database();\r\n      // 不使用userId过滤，直接查询所有记录（小程序端默认只能查询到自己创建的记录）\r\n      \r\n      db.collection(\"refund_requests\")\r\n        .orderBy(\"applyTime\", \"desc\")\r\n        .get({\r\n          success: (res) => {\r\n            console.log(\"退款记录查询结果:\", res.data);\r\n            this.refundOrders = res.data;\r\n            this.loading = false;\r\n            \r\n            if (typeof callback === \"function\") {\r\n              callback();\r\n            }\r\n          },\r\n          fail: (err) => {\r\n            console.error(\"查询退款记录失败:\", err);\r\n            this.loading = false;\r\n            uni.showToast({\r\n              title: \"加载记录失败\",\r\n              icon: \"none\"\r\n            });\r\n            \r\n            if (typeof callback === \"function\") {\r\n              callback();\r\n            }\r\n          }\r\n        });\r\n    },\r\n    \r\n    // 格式化日期\r\n    formatDate(dateObj) {\r\n      if (!dateObj) return \"\";\r\n      \r\n      // 处理云数据库的时间格式\r\n      let date;\r\n      if (typeof dateObj === \"object\" && dateObj.toDate) {\r\n        date = dateObj.toDate();\r\n      } else if (typeof dateObj === \"string\") {\r\n        date = new Date(dateObj);\r\n      } else {\r\n        date = new Date(dateObj);\r\n      }\r\n      \r\n      const year = date.getFullYear();\r\n      const month = String(date.getMonth() + 1).padStart(2, \"0\");\r\n      const day = String(date.getDate()).padStart(2, \"0\");\r\n      \r\n      return `${year}-${month}-${day}`;\r\n    },\r\n    \r\n    // 获取状态文本\r\n    getStatusText(status) {\r\n      const statusMap = {\r\n        \"待审核\": \"审核中\",\r\n        \"已通过\": \"已通过\",\r\n        \"已拒绝\": \"未通过\",\r\n        \"已退款\": \"已退款\"\r\n      };\r\n      return statusMap[status] || \"处理中\";\r\n    },\r\n    \r\n    // 获取状态对应的样式类\r\n    getStatusClass(status) {\r\n      if (status === \"待审核\") {\r\n        return \"status-pending\";\r\n      } else if (status === \"已通过\") {\r\n        return \"status-approved\";\r\n      } else if (status === \"已拒绝\") {\r\n        return \"status-rejected\";\r\n      } else if (status === \"已退款\") {\r\n        return \"status-refunded\";\r\n      }\r\n      return \"\";\r\n    },\r\n    \r\n    // 跳转到退押金详情进度页面\r\n    goToDetail(refundId, item) {\r\n      // 显示加载提示\r\n      uni.showLoading({\r\n        title: \"加载中...\",\r\n        mask: true\r\n      });\r\n      \r\n      console.log(\"准备跳转到退款详情页，ID:\", refundId);\r\n      \r\n      // 如果没有有效ID，直接返回\r\n      if (!refundId) {\r\n        uni.hideLoading();\r\n        uni.showToast({\r\n          title: \"无效的记录ID\",\r\n          icon: \"none\"\r\n        });\r\n        return;\r\n      }\r\n      \r\n      // 直接跳转到退款详情页，并传入refundId\r\n      // 每次都直接用ID去查询，不再依赖本地存储\r\n      uni.navigateTo({\r\n        url: `/pages/deposit/pay?id=${refundId}&type=detail&from=records&t=${Date.now()}`,\r\n        success: () => {\r\n          uni.hideLoading();\r\n        },\r\n        fail: (err) => {\r\n          console.error(\"跳转失败:\", err);\r\n          uni.hideLoading();\r\n          uni.showToast({\r\n            title: \"跳转失败\",\r\n            icon: \"none\"\r\n          });\r\n        }\r\n      });\r\n    },\r\n    \r\n    // 跳转到新建退款页\r\n    goToNewRefund() {\r\n      uni.navigateTo({\r\n        url: \"/pages/order/list?type=refundable\"\r\n      });\r\n    }\r\n  }\r\n};\r\n</script>\r\n\r\n<style>\r\n.refund-orders-container {\r\n  padding-bottom: 120rpx;\r\n}\r\n\r\n.page-header {\r\n  padding: 30rpx;\r\n  background-color: #fff;\r\n  margin-bottom: 20rpx;\r\n  border-bottom: 1rpx solid #f5f5f5;\r\n}\r\n\r\n.header-title {\r\n  font-size: 34rpx;\r\n  font-weight: bold;\r\n  text-align: center;\r\n}\r\n\r\n.refund-list {\r\n  padding: 0 30rpx;\r\n}\r\n\r\n.loading, .empty-state {\r\n  padding: 100rpx 0;\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  justify-content: center;\r\n}\r\n\r\n.empty-image {\r\n  width: 200rpx;\r\n  height: 200rpx;\r\n  margin-bottom: 20rpx;\r\n  opacity: 0.6;\r\n}\r\n\r\n.empty-text {\r\n  color: #999;\r\n  font-size: 28rpx;\r\n}\r\n\r\n.refund-item {\r\n  background-color: #fff;\r\n  border-radius: 12rpx;\r\n  padding: 30rpx;\r\n  margin-bottom: 20rpx;\r\n  box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.05);\r\n}\r\n\r\n.refund-info {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  margin-bottom: 20rpx;\r\n}\r\n\r\n.refund-product {\r\n  font-size: 32rpx;\r\n  font-weight: bold;\r\n  color: #333;\r\n}\r\n\r\n.refund-amount {\r\n  font-size: 32rpx;\r\n  font-weight: bold;\r\n  color: #ff5252;\r\n}\r\n\r\n.refund-meta {\r\n  margin-bottom: 20rpx;\r\n}\r\n\r\n.refund-order, .refund-time {\r\n  font-size: 26rpx;\r\n  color: #666;\r\n  margin-bottom: 10rpx;\r\n}\r\n\r\n.label {\r\n  color: #999;\r\n}\r\n\r\n.refund-status {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  padding-top: 20rpx;\r\n  border-top: 1rpx dashed #eee;\r\n}\r\n\r\n.status-tag {\r\n  padding: 4rpx 16rpx;\r\n  border-radius: 20rpx;\r\n  font-size: 24rpx;\r\n}\r\n\r\n.status-pending {\r\n  background-color: #e6f7ff;\r\n  color: #1890ff;\r\n}\r\n\r\n.status-approved {\r\n  background-color: #f6ffed;\r\n  color: #52c41a;\r\n}\r\n\r\n.status-rejected {\r\n  background-color: #fff1f0;\r\n  color: #f5222d;\r\n}\r\n\r\n.status-refunded {\r\n  background-color: #f9f0ff;\r\n  color: #722ed1;\r\n}\r\n\r\n.arrow {\r\n  color: #ccc;\r\n  font-size: 26rpx;\r\n}\r\n\r\n.fixed-bottom {\r\n  position: fixed;\r\n  bottom: 0;\r\n  left: 0;\r\n  right: 0;\r\n  padding: 20rpx 30rpx;\r\n  background-color: #fff;\r\n  border-top: 1rpx solid #f5f5f5;\r\n  z-index: 10;\r\n}\r\n\r\n.new-refund-btn {\r\n  width: 100%;\r\n  height: 80rpx;\r\n  background-color: #1296db;\r\n  color: #fff;\r\n  border-radius: 40rpx;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  font-size: 28rpx;\r\n}\r\n</style> ","import MiniProgramPage from 'C:/Users/Administrator/Desktop/wx-pos/pages/deposit/refund-orders.vue'\nwx.createPage(MiniProgramPage)"],"names":["wx","uni"],"mappings":";;;AAoDA,MAAK,YAAU;AAAA,EACb,OAAO;AACL,WAAO;AAAA,MACL,SAAS;AAAA,MACT,cAAc,CAAE;AAAA,MAChB,QAAQ;AAAA;AAAA;EAEX;AAAA,EACD,SAAS;AAEPA,kBAAE,KAAC,MAAM,KAAK;AAAA,MACZ,KAAK;AAAA,MACL,WAAW;AAAA,IACb,CAAC;AAGD,SAAK,SAASC,cAAG,MAAC,eAAe,QAAQ,KAAK;AAG9C,SAAK,iBAAgB;AAAA,EACtB;AAAA,EAED,SAAS;AAEP,SAAK,iBAAgB;AAGrBA,wBAAI,kBAAkB,uBAAuB;AAAA,EAC9C;AAAA,EACD,oBAAoB;AAClB,SAAK,iBAAiB,MAAM;AAC1BA,oBAAG,MAAC,oBAAmB;AAAA,IACzB,CAAC;AAAA,EACF;AAAA,EACD,SAAS;AAAA;AAAA,IAEP,iBAAiB,UAAU;AACzB,WAAK,UAAU;AAEf,YAAM,KAAKD,cAAAA,KAAG,MAAM,SAAQ;AAG5B,SAAG,WAAW,iBAAiB,EAC5B,QAAQ,aAAa,MAAM,EAC3B,IAAI;AAAA,QACH,SAAS,CAAC,QAAQ;AAChBC,wBAAA,MAAA,MAAA,OAAA,yCAAY,aAAa,IAAI,IAAI;AACjC,eAAK,eAAe,IAAI;AACxB,eAAK,UAAU;AAEf,cAAI,OAAO,aAAa,YAAY;AAClC;UACF;AAAA,QACD;AAAA,QACD,MAAM,CAAC,QAAQ;AACbA,wBAAA,MAAA,MAAA,SAAA,0CAAc,aAAa,GAAG;AAC9B,eAAK,UAAU;AACfA,wBAAAA,MAAI,UAAU;AAAA,YACZ,OAAO;AAAA,YACP,MAAM;AAAA,UACR,CAAC;AAED,cAAI,OAAO,aAAa,YAAY;AAClC;UACF;AAAA,QACF;AAAA,MACF,CAAC;AAAA,IACJ;AAAA;AAAA,IAGD,WAAW,SAAS;AAClB,UAAI,CAAC;AAAS,eAAO;AAGrB,UAAI;AACJ,UAAI,OAAO,YAAY,YAAY,QAAQ,QAAQ;AACjD,eAAO,QAAQ;MACjB,WAAW,OAAO,YAAY,UAAU;AACtC,eAAO,IAAI,KAAK,OAAO;AAAA,aAClB;AACL,eAAO,IAAI,KAAK,OAAO;AAAA,MACzB;AAEA,YAAM,OAAO,KAAK;AAClB,YAAM,QAAQ,OAAO,KAAK,SAAQ,IAAK,CAAC,EAAE,SAAS,GAAG,GAAG;AACzD,YAAM,MAAM,OAAO,KAAK,QAAS,CAAA,EAAE,SAAS,GAAG,GAAG;AAElD,aAAO,GAAG,IAAI,IAAI,KAAK,IAAI,GAAG;AAAA,IAC/B;AAAA;AAAA,IAGD,cAAc,QAAQ;AACpB,YAAM,YAAY;AAAA,QAChB,OAAO;AAAA,QACP,OAAO;AAAA,QACP,OAAO;AAAA,QACP,OAAO;AAAA;AAET,aAAO,UAAU,MAAM,KAAK;AAAA,IAC7B;AAAA;AAAA,IAGD,eAAe,QAAQ;AACrB,UAAI,WAAW,OAAO;AACpB,eAAO;AAAA,iBACE,WAAW,OAAO;AAC3B,eAAO;AAAA,iBACE,WAAW,OAAO;AAC3B,eAAO;AAAA,iBACE,WAAW,OAAO;AAC3B,eAAO;AAAA,MACT;AACA,aAAO;AAAA,IACR;AAAA;AAAA,IAGD,WAAW,UAAU,MAAM;AAEzBA,oBAAAA,MAAI,YAAY;AAAA,QACd,OAAO;AAAA,QACP,MAAM;AAAA,MACR,CAAC;AAEDA,oBAAY,MAAA,MAAA,OAAA,0CAAA,kBAAkB,QAAQ;AAGtC,UAAI,CAAC,UAAU;AACbA,sBAAG,MAAC,YAAW;AACfA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,QACR,CAAC;AACD;AAAA,MACF;AAIAA,oBAAAA,MAAI,WAAW;AAAA,QACb,KAAK,yBAAyB,QAAQ,+BAA+B,KAAK,IAAG,CAAE;AAAA,QAC/E,SAAS,MAAM;AACbA,wBAAG,MAAC,YAAW;AAAA,QAChB;AAAA,QACD,MAAM,CAAC,QAAQ;AACbA,wBAAA,MAAA,MAAA,SAAA,0CAAc,SAAS,GAAG;AAC1BA,wBAAG,MAAC,YAAW;AACfA,wBAAAA,MAAI,UAAU;AAAA,YACZ,OAAO;AAAA,YACP,MAAM;AAAA,UACR,CAAC;AAAA,QACH;AAAA,MACF,CAAC;AAAA,IACF;AAAA;AAAA,IAGD,gBAAgB;AACdA,oBAAAA,MAAI,WAAW;AAAA,QACb,KAAK;AAAA,MACP,CAAC;AAAA,IACH;AAAA,EACF;AACF;;;;;;;;;;;;;;;;;;;;;;;;;;;ACnNA,GAAG,WAAW,eAAe;"}